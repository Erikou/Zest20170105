{% extends "SEInputBundle:Entry:input.html.twig" %}

 {% block seinput_form %}

  <div class="well">
   {{ form_start(form, {'attr': {'class': 'form-horizontal'}}) }}

    {{ form_errors(form) }}

     <div class="form-group">
        {{ form_label(form.user, "User", {'label_attr': {'class': 'col-sm-3 control-label'}}) }}
        {{ form_errors(form.user) }}
        <div class="col-sm-4">
          {{ form_widget(form.user, {'attr': {'class': 'form-control'}}) }}
        </div>
    </div>

    <div class="form-group">
      {{ form_row(form.input_entries) }}  
    </div>

    {{ form_widget(form.save, {'attr': {'class': 'btn btn-success'}}) }}
    
    {{ form_rest(form) }}
    {{ form_end(form) }}
  </div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() {

    var $entryContainer = $('div#se_inputbundle_userinput_input_entries');
    var entryLabel = 'Entry n*';
    var entryIndex = $entryContainer.find(':input').length;
  
    var $addEntryLink = $('<a href="#" id="add_entry" class="btn btn-default">Add an entry</a>');
    $entryContainer.append($addEntryLink);

    $addEntryLink.click(function(e) {
      entryIndex = addElement($entryContainer, entryLabel, entryIndex);
      e.preventDefault(); 
      addSubCollection($entryContainer.children('div'), entryIndex -1);
      return false;
    });

    if (entryIndex == 0) {
        for (var i = 0; i < {{ EmployeeCount }}; i++) {
          entryIndex = addElement($entryContainer, entryLabel, entryIndex);
        } 
    } else {
      $entryContainer.children('div').each(function() {
        addDeleteLink($(this));
      });
    }

    //array de ahcontainer pour chaque entry
    var $ah = {
      container : [],
      idt : []
    };
    var ahLabel = 'Activity n*';
    var $addActivityLink = [];
 
    //on initialise les index et container de chaque ah
    $entryContainer.children('div').each(function(j) {
        addSubCollection($(this), j);
    }); 

    function addElement($container, lab, i) {
      var $prototype = $($container.attr('data-prototype').replace(/__name__label__/, lab + (i+1))
          .replace(/__name__/, i));
      addDeleteLink($prototype);
      $container.append($prototype);
      i++;
      return i;
    }

    function addDeleteLink($prototype) {
      $deleteLink = $('<a href="#" class="btn btn-danger">Delete</a>');
      $prototype.append($deleteLink);
      $deleteLink.click(function(e) {
        $prototype.remove();
        e.preventDefault();
        return false;
      });
    }

    function addSubCollection($parent, j) {  // j = parent new index $parent = $entryContainer.children('div') //.last()
      
      $ah.container.push($parent.find($("div[id*='se_inputbundle_userinput_input_entries_'][id*='_activity_hours']")).last());
      $ah.idt.push($ah.container[j].find(':input').length);

      $addActivityLink.push($('<a href="#" id="add_entry" class="btn btn-default">Add an activity</a>'));
      $ah.container[j].append($addActivityLink[j]);

      $addActivityLink[j].click(function(e) {
        $ah.idt[j] = addElement($ah.container[j], ahLabel, $ah.idt[j]);
        e.preventDefault(); 
        return false;
      });

      if ($ah.idt[j] == 0) {
        $ah.idt[j] = addElement($ah.container[j], ahLabel, $ah.idt[j]);
      } else {
        $ah.container[j].children('div').each(function() {
          addDeleteLink($(this));
        });
      }
    }

  });

</script>

{% endblock %}